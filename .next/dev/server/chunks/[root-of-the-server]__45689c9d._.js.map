{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Yira/Documents/code/gemini3-yira-s-website/app/api/island-identity/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\n// 简单的内存限流器\r\nconst rateLimiter = new Map<string, number[]>();\r\n\r\nfunction checkRateLimit(ip: string): boolean {\r\n  const now = Date.now();\r\n  const userRequests = rateLimiter.get(ip) || [];\r\n  \r\n  // 清理超过1分钟的请求记录\r\n  const recentRequests = userRequests.filter(time => now - time < 60000);\r\n  \r\n  if (recentRequests.length >= 2) {\r\n    return false; // 超过限制\r\n  }\r\n  \r\n  recentRequests.push(now);\r\n  rateLimiter.set(ip, recentRequests);\r\n  return true;\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    // 获取客户端 IP（用于限流）\r\n    const forwarded = request.headers.get(\"x-forwarded-for\");\r\n    const ip = forwarded ? forwarded.split(\",\")[0] : \"unknown\";\r\n    \r\n    // 检查限流\r\n    if (!checkRateLimit(ip)) {\r\n      return NextResponse.json(\r\n        { error: \"请求过于频繁，请稍后再试（每分钟最多2次）\" },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    const { personality } = await request.json();\r\n\r\n    if (!personality || personality.trim().length === 0) {\r\n      return NextResponse.json(\r\n        { error: \"请输入你的性格和喜好\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // 获取 API Key\r\n    const apiKey = process.env.TUZIAI_API_KEY;\r\n    if (!apiKey) {\r\n      console.error(\"Missing TUZIAI_API_KEY\");\r\n      return NextResponse.json(\r\n        { error: \"服务配置错误\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // 调用兔子 API\r\n    const response = await fetch(\"https://api.tu-zi.com/v1/chat/completions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Authorization\": `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"gpt-4o-mini\",\r\n        messages: [\r\n          {\r\n            role: \"system\",\r\n            content: `你是一位充满想象力的岛屿向导，专门为访客分配独特的岛屿身份。\r\n\r\n你的任务是根据用户描述的性格和喜好，为他们生成一个专属的岛屿角色。\r\n\r\n角色类型可以是：\r\n- 陆地动物（如狐狸、鹿、兔子、猫头鹰等）\r\n- 海洋生物（如海豚、水母、海龟、章鱼等）\r\n- 天空生物（如鸟类、蝴蝶、蜻蜓等）\r\n- 植物（如樱花树、仙人掌、蘑菇、藤蔓等）\r\n- 岛屿物品（如灯塔、风铃、贝壳、漂流瓶等）\r\n- 奇幻角色（如女巫、仙女、小精灵、守护者等）\r\n\r\n请以 JSON 格式返回，包含以下字段：\r\n{\r\n  \"role\": \"角色名称（中文，简短有诗意）\",\r\n  \"type\": \"角色类型（动物/植物/物品/奇幻角色）\",\r\n  \"description\": \"角色描述（50-80字，富有诗意和想象力，解释为什么这个角色适合用户）\",\r\n  \"traits\": [\"特质1\", \"特质2\", \"特质3\"],\r\n  \"emoji\": \"代表这个角色的emoji\"\r\n}\r\n\r\n要求：\r\n1. 角色要独特、有创意、富有诗意\r\n2. 描述要温暖、治愈、充满想象力\r\n3. 要紧密结合用户的性格特点\r\n4. 语言风格要符合\"小黑的奇幻岛屿\"的氛围：自由、温暖、有趣、充满可能性\r\n5. 只返回 JSON，不要有其他文字`,\r\n          },\r\n          {\r\n            role: \"user\",\r\n            content: `我的性格和喜好：${personality}`,\r\n          },\r\n        ],\r\n        temperature: 0.9,\r\n        max_tokens: 500,\r\n      }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorData = await response.json().catch(() => ({}));\r\n      console.error(\"API error:\", errorData);\r\n      throw new Error(\"API 调用失败\");\r\n    }\r\n\r\n    const data = await response.json();\r\n    const responseText = data.choices?.[0]?.message?.content;\r\n    \r\n    if (!responseText) {\r\n      throw new Error(\"AI 未返回内容\");\r\n    }\r\n\r\n    // 清理 markdown 代码块标记\r\n    let cleanedText = responseText.trim();\r\n    \r\n    // 移除 ```json 和 ``` 标记\r\n    if (cleanedText.startsWith(\"```json\")) {\r\n      cleanedText = cleanedText.replace(/^```json\\s*/, \"\");\r\n    }\r\n    if (cleanedText.startsWith(\"```\")) {\r\n      cleanedText = cleanedText.replace(/^```\\s*/, \"\");\r\n    }\r\n    if (cleanedText.endsWith(\"```\")) {\r\n      cleanedText = cleanedText.replace(/\\s*```$/, \"\");\r\n    }\r\n\r\n    // 解析 JSON 响应\r\n    const result = JSON.parse(cleanedText);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      identity: result,\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"Island identity generation error:\", error);\r\n    \r\n    if (error.message?.includes(\"JSON\")) {\r\n      return NextResponse.json(\r\n        { error: \"AI 响应格式错误，请重试\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    \r\n    return NextResponse.json(\r\n      { error: \"生成失败，请稍后重试\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}